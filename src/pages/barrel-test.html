<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Barrel</title>
  <style>
    body, h3, p {
      padding: 0;
      margin: 0;
    }
    .barrel {
      margin: 0 auto;
      width: 1000px;
    }
    .barrel-box {
      position: relative;
      display: inline-block;
      box-sizing: border-box;
    }
    .barrel-box .content {
      position: absolute;
      bottom: 0;
      color: #fff;
    }
    .barrel-box img {
      height: 100%;
    }
    .barrel-row {
      overflow: hidden;
      white-space: nowrap;
    }
  </style>
</head>
<body>
<h1 style="text-align: center;">木桶布局</h1>
  <div class="barrel">
    <div class="barrel-box">
      <img src="http://placehold.it/300x600/E97452/fff" alt="">
      <div class="content">
        <h3>Title</h3>
        <p>Picture</p>
      </div>
    </div>
    <div class="barrel-box">
      <img src="http://placehold.it/300x300/4C6EB4/fff" alt="">
      <div class="content">
        <h3>Title</h3>
        <p>Picture</p>
      </div>
    </div>
    <div class="barrel-box">
      <img src="http://placehold.it/300x250/449F93/fff" alt="">
      <div class="content">
        <h3>Title</h3>
        <p>Picture</p>
      </div>
    </div>
    <div class="barrel-box">
      <img src="http://placehold.it/200x320/936FBC/fff" alt="">
      <div class="content">
        <h3>Title</h3>
        <p>Picture</p>
      </div>
    </div>
    <div class="barrel-box">
      <img src="http://placehold.it/400x500/D25064/fff" alt="">
      <div class="content">
        <h3>Title</h3>
        <p>Picture</p>
      </div>
    </div>
    <div class="barrel-box">
      <img src="http://placehold.it/300x200/CF364A/fff" alt="">
      <div class="content">
        <h3>Title</h3>
        <p>Picture</p>
      </div>
    </div>
    <div class="barrel-box">
      <img src="http://placehold.it/300x400/E59649/fff" alt="">
      <div class="content">
        <h3>Title</h3>
        <p>Picture</p>
      </div>
    </div>
    <div class="barrel-box">
      <img src="http://placehold.it/350x500/75A0CC/fff" alt="">
      <div class="content">
        <h3>Title</h3>
        <p>Picture</p>
      </div>
    </div>
    <div class="barrel-box">
      <img src="http://placehold.it/300x200/4296AD/fff" alt="">
      <div class="content">
        <h3>Title</h3>
        <p>Picture</p>
      </div>
    </div>
    <div class="barrel-box">
      <img src="http://placehold.it/300x400/9FDBC7/fff" alt="">
      <div class="content">
        <h3>Title</h3>
        <p>Picture</p>
      </div>
    </div>
    <div class="barrel-box">
      <img src="http://placehold.it/300x300/4E8EF7/fff" alt="">
      <div class="content">
        <h3>Title</h3>
        <p>Picture</p>
      </div>
    </div>
    <div class="barrel-box">
      <img src="http://placehold.it/300x300/CE8EF7/fff" alt="">
      <div class="content">
        <h3>Title</h3>
        <p>Picture</p>
      </div>
    </div>
    <div class="barrel-box">
      <img src="http://placehold.it/500x350/936FBC/fff" alt="">
      <div class="content">
        <h3>Title</h3>
        <p>Picture</p>
      </div>
    </div>
    <div class="barrel-box">
      <img src="http://placehold.it/1300x1000/4A3E22/fff" alt="">
      <div class="content">
        <h3>Title</h3>
        <p>Picture</p>
      </div>
    </div>
    <div class="barrel-box">
      <img src="http://placehold.it/550x500/A941A2/fff" alt="">
      <div class="content">
        <h3>Title</h3>
        <p>Picture</p>
      </div>
    </div>
    <div class="barrel-box">
      <img src="http://placehold.it/800x400/98EFE7/fff" alt="">
      <div class="content">
        <h3>Title</h3>
        <p>Picture</p>
      </div>
    </div>
    <div class="barrel-box">
      <img src="http://placehold.it/400x400/4E8EF7/fff" alt="">
      <div class="content">
        <h3>Title</h3>
        <p>Picture</p>
      </div>
    </div>
    <div class="barrel-box">
      <img src="http://placehold.it/500x300/4ECAC7/fff" alt="">
      <div class="content">
        <h3>Title</h3>
        <p>Picture</p>
      </div>
    </div>
    <div class="barrel-box">
      <img src="http://placehold.it/600x800/4E8EF7/fff" alt="">
      <div class="content">
        <h3>Title</h3>
        <p>Picture</p>
      </div>
    </div>
    <div class="barrel-box">
      <img src="http://placehold.it/300x300/D25064/fff" alt="">
      <div class="content">
        <h3>Title</h3>
        <p>Picture</p>
      </div>
    </div>
    <div class="barrel-box">
      <img src="http://placehold.it/1400x800/E97452/fff" alt="">
      <div class="content">
        <h3>Title</h3>
        <p>Picture</p>
      </div>
    </div>
  </div>
<script>
  let Barrel = function (options) {
    options               = options || {};
    let containerSelector = options.containerSelector || '.barrel';
    let boxSelector       = options.boxSelector || '.barrel-box';
    this.rowMinHeight     = options.rowMinHeight || '200px';
    this.container        = document.querySelector(containerSelector);
    this.boxes            = this.container ? this.container.querySelectorAll(boxSelector) : [];

    for (let i = 0, length = this.boxes.length; i < length; i++) {
      // 原库中没有考虑宽度为0的情况，那 proportion 会变成 undefined
      this.boxes[i].proportion = this.boxes[i].clientWidth / this.boxes[i].clientHeight || 0;
    }

  }

  Barrel.prototype = {
    calcRow(min, max) {
      let height = this.rowMinHeight.replace(/px/, ''),
              rows   = [],
              width  = 0,
              count  = 0,
              totalWidth,
              rowHeight,
              proportion,
              i;

      for (i = 0; i < this.boxes.length; i++) {
        this.boxes[i].style.height = `${height}px`;
        this.boxes[i].style.width  = `${this.boxes[i].proportion * height}px`;
        width += this.boxes[i].proportion * height;
        count++;
        if ((width > this.container.clientWidth && count > min) || count > max) {
          totalWidth = width - this.boxes[i].clientWidth;
          proportion = height / totalWidth;
          rowHeight  = this.container.clientWidth * proportion;
          rows.push({number: i - 1, height: rowHeight});
          width = this.boxes[i].clientWidth;
          count = 1;
        }
      }

      rows.push({number: i, height: 200});
      return rows;
    },
    overWrite() {
      let rows  = this.calcRow(3, 6);
      let index = 0;
      this.initRow(rows);

      for (let i = 0, length = this.boxes.length; i < length; i++) {
        if (i > rows[index].number) index++;
        this.boxes[i].style.width = '';
        this.boxes[i].style.height = '100%';
        this.addBox(this.boxes[i], index);
      }
    },
    initRow(rows) {
      this.rows = [];
      for (let i = 0, length = rows.length; i < length; i++) {
        let rowDiv = document.createElement('div');
        rowDiv.className = 'barrel-row';
        rowDiv.style.height = `${rows[i].height}px`;
        this.rows.push(rowDiv);
        this.container.appendChild(rowDiv);
      }
    },
    addBox(ele, index) {
      let row = this.rows[index];
      row.appendChild(ele);
    }
  };

  window.onload = () => {
    let barrel = new Barrel();
    barrel.overWrite();
  }
</script>
</body>
</html>